name: CI/CD - NGINX Helm

on:
  workflow_dispatch:
    inputs:
      go-nogo-id:
        description: 'Enter Go-NoGo ID'
        required: true
      change-request-id:
        description: 'Enter Change Request ID'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Required Secrets
        run: |
          echo "🔍 Validating secrets..."
          if [[ -z "${{ secrets.GCP_SA_KEY }}" ]]; then echo "❌ GCP_SA_KEY is missing"; exit 1; fi
          if [[ -z "${{ secrets.REGION }}" ]]; then echo "❌ REGION is missing"; exit 1; fi
          if [[ -z "${{ secrets.GCP_PROJECT }}" ]]; then echo "❌ GCP_PROJECT is missing"; exit 1; fi
          if [[ "${{ secrets.REGION }}" == *$'\n'* || "${{ secrets.GCP_PROJECT }}" == *$'\n'* ]]; then
            echo "❌ REGION or GCP_PROJECT contains newline characters"; exit 1;
          fi
            echo "✅ All required secrets look good."
          
      - name: Authenticate with Google Cloud
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud auth configure-docker "${{ secrets.REGION }}-docker.pkg.dev"
          
      - name: Build Docker Image
        run: |
          IMAGE_URI="${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/nginx-images/nginx-dev:latest"
          echo "🔨 Building image: $IMAGE_URI"
          docker build -t "$IMAGE_URI" .

      - name: Push Docker Image
        run: |
          IMAGE_URI="${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/nginx-images/nginx-dev:latest"
          echo "🚀 Pushing image: $IMAGE_URI"
          docker push "$IMAGE_URI"

  static-analysis:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Scan Docker Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/nginx-images/nginx-dev:latest'

  test:
    needs: static-analysis
    runs-on: ubuntu-latest
    steps:
      - name: Run Test
        run: echo "Tests Passed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://34.118.226.69
    steps:
      - uses: actions/checkout@v4
      - name: Auth GCP
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud config set project ${{ secrets.GCP_PROJECT }}
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER }} --zone ${{ secrets.GKE_ZONE }}
      - name: Helm Upgrade
        run: |
          helm upgrade --install nginx-dev ./charts/nginx-dev -n dev --create-namespace

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "channel": "#devops-alerts",
              "username": "GitHub CI",
              "text": "✅ *Deployment successful*: nginx-dev was deployed to `${{ secrets.GKE_CLUSTER }}` in project `${{ secrets.GCP_PROJECT }}`",
              "icon_emoji": ":rocket:"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

