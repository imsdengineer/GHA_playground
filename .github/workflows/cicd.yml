name: CI/CD - NGINX Helm

on:
  workflow_dispatch:
    inputs:
      go-nogo-id:
        description: 'Enter Go-NoGo ID'
        required: true
      change-request-id:
        description: 'Enter Change Request ID'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Required Secrets
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ] || \
             [ -z "${{ secrets.REGION }}" ] || \
             [ -z "${{ secrets.GCP_PROJECT }}" ]; then
            echo "❌ One or more required secrets are missing: GCP_SA_KEY, REGION, GCP_PROJECT"
            exit 1
          fi
          
      - name: Authenticate with Google Cloud
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud auth configure-docker "${{ secrets.REGION }}-docker.pkg.dev"
          
      - name: Build Docker Image with Buildx
        run: |
          docker buildx build --load -t "${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/nginx-images/nginx-dev:latest" .

      - name: Push Docker Image
        run: |
          docker push "${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/nginx-images/nginx-dev:latest"

  static-analysis:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Scan Docker Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/nginx-images/nginx-dev:latest'

  test:
    needs: static-analysis
    runs-on: ubuntu-latest
    steps:
      - name: Run Test
        run: echo "Tests Passed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://34.118.226.69
    steps:
      - uses: actions/checkout@v4
      - name: Auth GCP
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud config set project ${{ secrets.GCP_PROJECT }}
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER }} --zone ${{ secrets.GKE_ZONE }}
      - name: Helm Upgrade
        run: |
          helm upgrade --install nginx-dev ./charts/nginx-dev -n dev --create-namespace

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "channel": "#devops-alerts",
              "username": "GitHub CI",
              "text": "✅ *Deployment successful*: nginx-dev was deployed to `${{ secrets.GKE_CLUSTER }}` in project `${{ secrets.GCP_PROJECT }}`",
              "icon_emoji": ":rocket:"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

