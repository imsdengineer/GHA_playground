name: CI/CD - NGINX Helm

on:
  workflow_dispatch:
    inputs:
      go-nogo-id:
        description: 'Enter Go-NoGo ID'
        required: true
      change-request-id:
        description: 'Enter Change Request ID'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "❌ Missing required secret: GCP_SA_KEY"
            exit 1
          fi

      - name: Authenticate with GCP
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build Docker Image
        run: |
          docker build -t us-central1-docker.pkg.dev/my-new-env/nginx-images/nginx-dev:latest .

      - name: Push Docker Image
        run: |
          docker push us-central1-docker.pkg.dev/my-new-env/nginx-images/nginx-dev:latest

  static-analysis:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'us-central1-docker.pkg.dev/my-new-env/nginx-images/nginx-dev:latest'

  test:
    needs: static-analysis
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate with GCP
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud auth configure-docker us-central1-docker.pkg.dev
      - name: Run Tests
        run: echo "✅ All tests passed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://34.118.226.69
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate and Get GKE Credentials
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > key.json
          gcloud auth activate-service-account --key-file=key.json
          gcloud config set project my-new-env
          gcloud container clusters get-credentials poc-k8s --zone us-central1-c

      - name: Deploy via Helm
        run: |
          helm upgrade --install nginx-dev ./charts/nginx-dev -n dev --create-namespace

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Notification
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "channel": "#devops-alerts",
              "username": "GitHub CI",
              "text": "✅ *nginx-dev* was deployed to *poc-k8s* in *my-new-env* project successfully.",
              "icon_emoji": ":rocket:"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
